<!-- SIMPAN sebagai bendahara.html -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Bendahara</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<style>
  * { -webkit-tap-highlight-color: transparent; }
  a { text-decoration: none; }
  button {text-decoration: none;}
</style>
<body class="bg-gray-100 min-h-screen p-6 relative">

  <!-- Tombol Logout -->
  <a href="index.html" class="absolute top-4 right-4 p-2 rounded hover:bg-gray-200" title="Logout">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 002 2h3a2 2 0 002-2V7a2 2 0 00-2-2h-3a2 2 0 00-2 2v1" />
  </svg>
</a>


  <h1 class="text-2xl font-bold mb-4 text-center">LAMAN BENDAHARA</h1>

  <!-- ... bagian head tetap ... -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-0">
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-lg font-semibold">Total User Login</h2>
    <p id="totalUser" class="text-3xl font-bold text-blue-600">0</p>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-lg font-semibold">User Data Lengkap</h2>
    <p id="totalLengkap" class="text-3xl font-bold text-green-600">0</p>
  </div>

  <div class="relative bg-white p-4 rounded shadow">
    <button id="dropdownBtn" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">ğŸ‘¤ Daftar User</button>
    <p class="mt-1 text-sm text-gray-600">akun - password - Pengurus</p>

    <!-- Dropdown muncul ke bawah -->
    <div id="dropdownMenu" class="absolute top-full mt-2 w-80 bg-white border border-gray-300 rounded shadow hidden z-50">
      <div class="max-h-60 overflow-y-auto">
        <ul id="userList" class="text-sm divide-y divide-gray-200"></ul>
      </div>
    </div>
  </div>
</div>



  <!-- Tabel Pembayaran -->

 <div class="overflow-x-auto max-h-[60vh] overflow-y-auto mb-24 border rounded bg-white">
  <table class="w-full text-sm text-left border-collapse">
    <thead class="bg-gray-200 sticky top-0 z-10">
      <p>Verifikasi payment</p>
      <tr>
        <th class="p-2 border">Jam & Tanggal</th>
        <th class="p-2 border">Nama</th>
        <th class="p-2 border">Jenis</th>
        <th class="p-2 border">Saldo</th>
        <th class="p-2 border">Bank</th>
        <th class="p-2 border">Pengirim</th>
        <th class="p-2 border">Status</th>
        <th class="p-2 border">Verifikasi</th>
        <th class="p-2 border">Hapus</th>
      </tr>
    </thead>
    <tbody id="tabelVerifikasi"></tbody>
  </table>
</div>

  <!-- Overlay Edit User -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">

    <div class="bg-white p-6 rounded-lg w-full max-w-md relative">
      <button id="closeOverlay" class="absolute top-2 right-3 text-lg">âŒ</button>
      <h2 class="text-lg font-semibold mb-4">Edit User</h2>
      <table class="w-full mb-4 border">
        <thead>
          <tr class="bg-gray-100">
            <th class="p-2 border">Akun</th>
            <th class="p-2 border">Password</th>
            <th class="p-2 border">Pengurus</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="border p-2"><input id="editAkun" class="border px-2 py-1 w-full rounded" /></td>
            <td class="border p-2"><input id="editPassword" class="border px-2 py-1 w-full rounded bg-gray-100" disabled /></td>
            <td class="border p-2"><input id="editPengurus" class="border px-2 py-1 w-full rounded" /></td>
          </tr>
        </tbody>
      </table>
      <div class="flex justify-between mt-4">
        <button id="hapusPermanen" class="bg-red-600 text-white px-4 py-2 rounded">ğŸ—‘ï¸ Hapus Permanen</button>
        <button id="simpanPermanen" class="bg-green-600 text-white px-4 py-2 rounded">ğŸ’¾ Simpan Permanen</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpPEkKbEt6b_v2OWlBfGuaVQpBg2-RWR4",
      authDomain: "cwu-gen-2.firebaseapp.com",
      databaseURL: "https://cwu-gen-2-default-rtdb.firebaseio.com",
      projectId: "cwu-gen-2",
      storageBucket: "cwu-gen-2.appspot.com",
      messagingSenderId: "40585612014",
      appId: "1:40585612014:web:c88141fee369aca68181ff"
    };
    

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tabel = document.getElementById("tabelVerifikasi");
    const totalUserEl = document.getElementById("totalUser");
    const totalLengkapEl = document.getElementById("totalLengkap");
    const dropdownBtn = document.getElementById("dropdownBtn");
    const dropdownMenu = document.getElementById("dropdownMenu");
    const userList = document.getElementById("userList");

    const overlay = document.getElementById("overlay");
    const closeOverlay = document.getElementById("closeOverlay");
    const editAkun = document.getElementById("editAkun");
    const editPassword = document.getElementById("editPassword");
    const editPengurus = document.getElementById("editPengurus");
    const simpanPermanen = document.getElementById("simpanPermanen");
    const hapusPermanen = document.getElementById("hapusPermanen");

    let selectedUserKey = null;

    dropdownBtn.addEventListener("click", () => {
      dropdownMenu.classList.toggle("hidden");
    });

    onValue(ref(db, "users"), (snapshot) => {
      const data = snapshot.val() || {};
      userList.innerHTML = "";
      let total = 0, lengkap = 0;
      Object.entries(data).forEach(([key, user]) => {
        total++;
        if (user.nama) lengkap++;
        const li = document.createElement("li");
        li.className = "flex justify-between items-center px-4 py-2 hover:bg-gray-100";
        li.innerHTML = `
          <span>${key} - ${user.password || '-'} - ${user.nama || '-'}</span>
          
          <button class="text-blue-600 no-underline text-sm focus:outline-none" data-key="${key}" data-user='${JSON.stringify(user)}'>âš™ï¸</button>

        `;
        userList.appendChild(li);
      });
      totalUserEl.textContent = total;
      totalLengkapEl.textContent = lengkap;
    });

    userList.addEventListener("click", (e) => {
      if (e.target.matches("button[data-key]")) {
        selectedUserKey = e.target.dataset.key;
        const user = JSON.parse(e.target.dataset.user);
        editAkun.value = selectedUserKey;
        editPassword.value = user.password || "";
        editPengurus.value = user.nama || "";
        overlay.classList.remove("hidden");
      }
    });

    closeOverlay.onclick = () => overlay.classList.add("hidden");

    simpanPermanen.onclick = async () => {
      if (!selectedUserKey) return;
      const newKey = editAkun.value.trim();
      const nama = editPengurus.value.trim();
      const password = editPassword.value.trim();

      if (newKey !== selectedUserKey) {
        const snapshot = await ref(db, `users/${newKey}`);
        await update(ref(db, `users/${newKey}`), {
          nama: nama,
          password: password
        });
        await remove(ref(db, `users/${selectedUserKey}`));
      } else {
        await update(ref(db, `users/${selectedUserKey}`), { nama });
      }
      overlay.classList.add("hidden");
    };

    hapusPermanen.onclick = async () => {
      if (confirm("Hapus akun ini secara permanen?") && selectedUserKey) {
        await remove(ref(db, `users/${selectedUserKey}`));
        overlay.classList.add("hidden");
      }
    };

    // Tambahan event Firebase untuk tabel verifikasi dan edit saldo (sama seperti sebelumnya)
    onValue(ref(db, "pembayaran"), (snapshot) => {
      tabel.innerHTML = "";
      const data = snapshot.val();
      if (!data) return;

      Object.entries(data).reverse().forEach(([id, item]) => {
        const tr = document.createElement("tr");
        const statusLabel = item.status === "diterima"
          ? '<span class="bg-green-500 text-white px-2 py-1 rounded">Diterima</span>'
          : '<span class="bg-red-500 text-white px-2 py-1 rounded">Send</span>';

        tr.innerHTML = `
          <td class="border p-2">${item.tgl || '-'}</td>
          <td class="border p-2">${item.nama || '-'}</td>
          <td class="border p-2">${item.jenis || '-'}</td>
          <td class="border p-2"><input type="number" class="inputSaldo border rounded px-2 py-1 w-24" value="${item.saldo || 0}" data-id="${id}" data-uid="${item.uid}" /></td>
          <td class="border p-2">${item.bankPengirim || '-'}</td>
          <td class="border p-2">${item.rekeningPengirim || '-'}</td>
          <td class="border p-2">${statusLabel}</td>
          <td class="border p-2 text-center"><input type="checkbox" ${item.status === "diterima" ? "checked" : ""} data-id="${id}" data-uid="${item.uid}" class="verifCheckbox" /></td>
          <td class="border p-2 text-center"><button class="hapusBtn text-red-600" data-id="${id}" data-uid="${item.uid}">ğŸ—‘ï¸</button></td>
        `;
        tabel.appendChild(tr);
      });
    });

    document.addEventListener("change", async (e) => {
      if (e.target.classList.contains("verifCheckbox")) {
        const { id, uid } = e.target.dataset;
        const status = e.target.checked ? "diterima" : "pending";
        await update(ref(db, `pembayaran/${id}`), { status });
        await update(ref(db, `users/${uid}/pembayaran/${id}`), { status });
      }

      if (e.target.classList.contains("inputSaldo")) {
        const { id, uid } = e.target.dataset;
        const saldo = parseInt(e.target.value) || 0;
        await update(ref(db, `pembayaran/${id}`), { saldo });
        await update(ref(db, `users/${uid}/pembayaran/${id}`), { saldo });
      }
    });

    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("hapusBtn")) {
        const { id, uid } = e.target.dataset;
        if (confirm("Yakin ingin menghapus data ini?")) {
          await remove(ref(db, `pembayaran/${id}`));
          await remove(ref(db, `users/${uid}/pembayaran/${id}`));
        }
      }
    });
  </script>
  <a href="https://docs.google.com/spreadsheets/d/14LrpDUZDxsvRBTYd6nIn8RKA5sbStcyjIGpJMvlUPgs/edit?usp=sharing"
   class="fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
  <span>Data</span>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
       class="w-5 h-5">
    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
  </svg>
</a>

</body>
</html>
